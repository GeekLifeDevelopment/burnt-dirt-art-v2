---
import Layout from '../../layouts/Layout.astro';
import * as contentful from 'contentful';

export async function getStaticPaths() {
  const client = contentful.createClient({
    space: import.meta.env.CONTENTFUL_SPACE_ID,
    accessToken: import.meta.env.CONTENTFUL_ACCESS_TOKEN
  });

  try {
    const entries = await client.getEntries({ 
      content_type: 'artProduct'
    });

    console.log(`Building ${entries.items.length} product pages`);
    
    return entries.items
      .filter((item: any) => item.fields.inventoryCode) // Only include items with inventoryCode
      .map((item: any) => {
        console.log(`Creating page for: ${item.fields.inventoryCode} - ${item.fields.title || 'Untitled'}`);
        return {
          params: { slug: item.fields.inventoryCode },
          props: { item }
        };
      });
  } catch (error) {
    console.error('Error fetching products for static paths:', error);
    return [];
  }
}

// Helper function to extract plain text from Contentful rich text
function extractText(richText: any): string {
  if (!richText || !richText.content) return '';
  
  let text = '';
  const traverse = (node: any) => {
    if (node.nodeType === 'text') {
      text += node.value;
    }
    if (node.content && Array.isArray(node.content)) {
      node.content.forEach((child: any) => {
        traverse(child);
        // Add line breaks after paragraphs and headings
        if (['paragraph', 'heading-1', 'heading-2', 'heading-3'].includes(child.nodeType)) {
          text += '\n';
        }
      });
    }
  };
  traverse(richText);
  return text.trim();
}

const { item } = Astro.props;
const description = typeof item.fields.description === 'string' 
  ? item.fields.description 
  : extractText(item.fields.description);

// Extract URL from productLink if it's an object
const productLink = typeof item.fields.productLink === 'string'
  ? item.fields.productLink
  : extractText(item.fields.productLink);
---

<Layout>
    <div class="productContainer">
        <div class="productContent">
            <div class="imageSection">
                {item.fields.image && (
                    <img 
                        src={`https:${item.fields.image.fields.file.url}`}
                        alt={item.fields.title || item.fields.inventoryCode}
                        class="productImage"
                    />
                )}
            </div>
            
            <div class="detailsSection">
                <h1>{item.fields.title || item.fields.inventoryCode}</h1>
                
                {item.fields.price && (
                    <p class="price">${item.fields.price}</p>
                )}
                
                {item.fields.dimensions && (
                    <div class="detailItem">
                        <strong>Dimensions:</strong> {item.fields.dimensions}
                    </div>
                )}
                
                {item.fields.dateCompleted && (
                    <div class="detailItem">
                        <strong>Completed:</strong> {new Date(item.fields.dateCompleted).toLocaleDateString()}
                    </div>
                )}
                
                {description && (
                    <div class="description">
                        <h3>Description</h3>
                        <p style="white-space: pre-wrap;">{description}</p>
                    </div>
                )}
                
                <div class="actions">
                    {productLink && (
                        <a href={productLink} target="_blank" rel="noopener noreferrer" class="ebayButton">
                            View on eBay
                        </a>
                    )}
                    <a href="/shop" class="backButton">Back to Shop</a>
                </div>
            </div>
        </div>
    </div>
</Layout>

<style>
    .productContainer {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .productContent {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
        margin-top: 2rem;
    }

    .imageSection {
        position: sticky;
        top: 2rem;
        height: fit-content;
    }

    .productImage {
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .detailsSection h1 {
        margin-top: 0;
        color: rgb(182, 84, 48);
    }

    .price {
        font-size: 2rem;
        font-weight: bold;
        color: rgb(182, 84, 48);
        margin: 1rem 0;
    }

    .detailItem {
        margin: 1rem 0;
        font-size: 1.1rem;
    }

    .description {
        margin: 2rem 0;
    }

    .description h3 {
        color: rgb(182, 84, 48);
        margin-bottom: 0.5rem;
    }

    .description p {
        line-height: 1.6;
        color: #333;
    }

    .actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .ebayButton, .backButton {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    .ebayButton {
        background-color: rgb(182, 84, 48);
        color: white;
    }

    .ebayButton:hover {
        background-color: rgb(150, 60, 30);
    }

    .backButton {
        background-color: #e0e0e0;
        color: #333;
    }

    .backButton:hover {
        background-color: #d0d0d0;
    }

    @media (max-width: 768px) {
        .productContent {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .imageSection {
            position: static;
        }

        .actions {
            flex-direction: column;
        }
    }
</style>
