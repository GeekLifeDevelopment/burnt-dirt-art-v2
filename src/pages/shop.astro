---
import Layout from '../layouts/Layout.astro';
import * as contentful from 'contentful';
import { artistName } from '../config/seo';

// Get environment variables with fallbacks for Netlify builds
const space = import.meta.env.CONTENTFUL_SPACE_ID || process.env.CONTENTFUL_SPACE_ID;
const accessToken = import.meta.env.CONTENTFUL_ACCESS_TOKEN || process.env.CONTENTFUL_ACCESS_TOKEN;

// Fetch shop items from Contentful
let shopItems: any[] = [];
let categories: string[] = [];

function extractText(richText: any): string {
    if (!richText || !richText.content) return '';

    let text = '';
    const traverse = (node: any) => {
        if (node.nodeType === 'text') {
            text += node.value;
        }
        if (node.content && Array.isArray(node.content)) {
            node.content.forEach((child: any) => {
                traverse(child);
                if (['paragraph', 'heading-1', 'heading-2', 'heading-3'].includes(child.nodeType)) {
                    text += '\n';
                }
            });
        }
    };

    traverse(richText);
    return text.trim();
}

function toText(value: any): string {
    if (!value) return '';
    if (typeof value === 'string') return value.trim();
    return extractText(value);
}
if (!space || !accessToken) {
    console.warn(
        'Missing Contentful credentials. Shop page will render without product data. ' +
        'Set CONTENTFUL_SPACE_ID and CONTENTFUL_ACCESS_TOKEN in Netlify environment variables.'
    );
} else {
    const client = contentful.createClient({
        space,
        accessToken
  });

    try {
        const entries = await client.getEntries({ 
            content_type: 'artProduct'
        });
        shopItems = entries.items;
    
        // Extract unique categories with normalization
        const categorySet = new Set<string>();
        shopItems.forEach(item => {
            if (item.fields.category) {
                // Convert to string, trim whitespace and normalize the category
                const normalizedCategory = String(item.fields.category).trim();
                if (normalizedCategory) {
                    categorySet.add(normalizedCategory);
                }
      }
        });
        categories = Array.from(categorySet).sort();
    } catch (error) {
        console.error('Error fetching Contentful data:', error);
    }
}

const siteUrl = Astro.site?.toString() || 'https://burntdirtart.com';

const itemListElements = shopItems
    .map((item, index) => {
        const externalUrl = toText(item.fields.productLink);
        if (!externalUrl) return null;

        const imageUrl = item.fields.images?.[0]?.fields?.file?.url
            ? `https:${item.fields.images[0].fields.file.url}`
            : undefined;

        return {
            '@type': 'ListItem',
            position: index + 1,
            item: {
                '@type': 'VisualArtwork',
                name: item.fields.title || item.fields.inventoryCode || 'Artwork Listing',
                url: externalUrl,
                image: imageUrl
            }
        };
    })
    .filter(Boolean);

const pageSchema = itemListElements.length
    ? {
        '@context': 'https://schema.org',
        '@type': 'ItemList',
        name: 'Burnt Dirt Art eBay Listings',
        url: new URL('/shop', siteUrl).toString(),
        numberOfItems: itemListElements.length,
        itemListElement: itemListElements,
        author: {
            '@type': 'Person',
            name: artistName
        }
    }
    : undefined;
---

<Layout
    pageTitle="Shop Original Art"
    description="Browse available Burnt Dirt Art pieces and visit eBay listings for purchase details, pricing, and current availability."
    canonicalPath="/shop"
    pageSchema={pageSchema}
>
    <div class="shopContainer">
        <h1>Shop</h1>
        <p class="shopIntro">
            Browse current available work below. Purchases are completed through eBay listings, where you can view full details, shipping info, and current pricing.
        </p>
        <p class="shopUpdates">
            Listings update regularly as new original pieces and handmade functional art are completed.
        </p>
        
        {shopItems.length > 0 ? (
            <>
                <div class="filterContainer">
                    <label for="categoryFilter">Filter by Category:</label>
                    <select id="categoryFilter">
                        <option value="all">All Categories</option>
                        {categories.map(category => (
                            <option value={category}>{category}</option>
                        ))}
                    </select>
                </div>
                
                <div class="shopGrid">
                    {shopItems.map((item) => (
                        <div class="shopItem" data-category={item.fields.category ? String(item.fields.category).trim() : 'uncategorized'}>
                            {item.fields.images && item.fields.images.length > 0 && (
                                <img 
                                    src={`https:${item.fields.images[0].fields.file.url}`}
                                    alt={item.fields.title || item.fields.inventoryCode}
                                    width={item.fields.images[0].fields.file.details?.image?.width}
                                    height={item.fields.images[0].fields.file.details?.image?.height}
                                    loading="lazy"
                                    decoding="async"
                                />
                            )}
                            <h3>{item.fields.title || item.fields.inventoryCode}</h3>
                            {item.fields.price && (
                                <p class="price">${item.fields.price}</p>
                            )}
                            {toText(item.fields.productLink) && (
                                <a
                                    href={toText(item.fields.productLink)}
                                    class="detailsLink ebayLink"
                                    target="_blank"
                                    rel="noopener noreferrer sponsored"
                                >
                                    View on eBay
                                </a>
                            )}
                            {item.fields.inventoryCode ? (
                                <a href={`/shop/${item.fields.inventoryCode}`} class="detailsLink">
                                    Click for more details
                                </a>
                            ) : (
                                <span class="noLink">Details unavailable</span>
                            )}
                        </div>
                    ))}
                </div>
            </>
        ) : (
            <p>Visit my eBay store to purchase original artwork and prints: <a href="https://www.ebay.com/sch/i.html?_ssn=burnt-dirt-art" target="_blank" rel="noopener noreferrer sponsored">Burnt Dirt Art on eBay</a></p>
        )}
    </div>

    
</Layout>

<script>
    const categoryFilter = document.getElementById('categoryFilter') as HTMLSelectElement;
    const shopItems = document.querySelectorAll('.shopItem');

    categoryFilter?.addEventListener('change', () => {
        const selectedCategory = categoryFilter.value;

        shopItems.forEach((item) => {
            const itemCategory = item.getAttribute('data-category');
            
            if (selectedCategory === 'all' || itemCategory === selectedCategory) {
                (item as HTMLElement).style.display = 'block';
            } else {
                (item as HTMLElement).style.display = 'none';
            }
        });
    });
</script>

<style>
    .shopContainer {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .filterContainer {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin: 1.5rem 0;
        padding: 1rem;
        background-color: #f5f5f5;
        border-radius: 8px;
    }

    .filterContainer label {
        font-weight: bold;
    }

    .filterContainer select {
        padding: 0.5rem 1rem;
        border: 2px solid rgb(182, 84, 48);
        border-radius: 4px;
        font-size: 1rem;
        background-color: white;
        cursor: pointer;
    }

    .filterContainer select:focus {
        outline: none;
        border-color: rgb(150, 60, 30);
    }

    .shopGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .shopIntro,
    .shopUpdates {
        max-width: 850px;
        line-height: 1.6;
        margin-top: 0.5rem;
    }

    .shopItem {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }

    .shopItem img {
        width: 100%;
        height: 300px;
        object-fit: contain;
        border-radius: 4px;
    }

    .shopItem h3 {
        margin: 1rem 0 0.5rem;
    }

    .price {
        font-size: 1.5rem;
        font-weight: bold;
        color: rgb(182, 84, 48);
        margin: 0.5rem 0;
    }

    .detailsLink {
        display: inline-block;
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: rgb(182, 84, 48);
        color: white;
        text-decoration: none;
        border-radius: 4px;
        transition: background-color 0.3s;
        font-size: 0.9rem;
    }

    .detailsLink:hover {
        background-color: rgb(150, 60, 30);
    }

    .ebayLink {
        margin-right: 0.5rem;
    }
</style>