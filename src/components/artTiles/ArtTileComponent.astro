---
import "./artTile.styles.css";
import * as contentful from 'contentful';

const space = import.meta.env.CONTENTFUL_SPACE_ID || process.env.CONTENTFUL_SPACE_ID;
const accessToken = import.meta.env.CONTENTFUL_ACCESS_TOKEN || process.env.CONTENTFUL_ACCESS_TOKEN;

type HomeArtPiece = {
  imageUrl: string;
  imageWidth?: number;
  imageHeight?: number;
  title: string;
  description: string;
  storeUrl?: string;
};

function extractText(richText: any): string {
  if (!richText || !richText.content) return '';

  let text = '';
  const traverse = (node: any) => {
    if (node.nodeType === 'text') {
      text += node.value;
    }
    if (node.content && Array.isArray(node.content)) {
      node.content.forEach((child: any) => {
        traverse(child);
        if (['paragraph', 'heading-1', 'heading-2', 'heading-3'].includes(child.nodeType)) {
          text += '\n';
        }
      });
    }
  };

  traverse(richText);
  return text.trim();
}

function toText(value: any): string {
  if (!value) return '';
  if (typeof value === 'string') return value.trim();
  return extractText(value);
}

function normalizeToList(value: any): string[] {
  if (!value) return [];

  if (Array.isArray(value)) {
    return value
      .map((entry) => (typeof entry === 'string' ? entry : String(entry ?? '')))
      .map((entry) => entry.trim().toLowerCase())
      .filter(Boolean);
  }

  if (typeof value === 'string') {
    return value
      .split(/[;,]/)
      .map((entry) => entry.trim().toLowerCase())
      .filter(Boolean);
  }

  return [String(value).trim().toLowerCase()].filter(Boolean);
}

function hasPageSelection(item: any, key: 'home' | 'shop' | 'store'): boolean {
  const candidates = [
    item.fields.page,
    item.fields.pages,
    item.fields.pageSection,
    item.fields.pageSections,
    item.fields.sections
  ];

  const values = candidates.flatMap((candidate) => normalizeToList(candidate));
  if (values.includes(key)) return true;

  if (key === 'shop' && values.includes('store')) return true;
  if (key === 'store' && values.includes('shop')) return true;

  return false;
}

let artPieces: HomeArtPiece[] = [];

if (!space || !accessToken) {
  console.warn(
    'Missing Contentful credentials. Home art tiles will render without Contentful data. ' +
      'Set CONTENTFUL_SPACE_ID and CONTENTFUL_ACCESS_TOKEN in environment variables.'
  );
} else {
  const client = contentful.createClient({
    space,
    accessToken
  });

  try {
    const entries = await client.getEntries({
      content_type: 'artProduct'
    });

    artPieces = entries.items
      .filter((item: any) => {
        if (item.fields.home === true) return true;
        return hasPageSelection(item, 'home');
      })
      .map((item: any) => {
        const firstImage = item.fields.images?.[0];
        const file = firstImage?.fields?.file;
        const imageUrl = file?.url ? `https:${file.url}` : '';

        const isStoreChecked =
          item.fields.store === true ||
          item.fields.shop === true ||
          hasPageSelection(item, 'store') ||
          hasPageSelection(item, 'shop');

        const storeUrl =
          isStoreChecked && item.fields.inventoryCode
            ? `/shop/${item.fields.inventoryCode}`
            : undefined;

        return {
          imageUrl,
          imageWidth: file?.details?.image?.width,
          imageHeight: file?.details?.image?.height,
          title: item.fields.title || item.fields.inventoryCode || 'Untitled Artwork',
          description: toText(item.fields.description) || '',
          storeUrl
        } satisfies HomeArtPiece;
      })
      .filter((item: HomeArtPiece) => Boolean(item.imageUrl));
  } catch (error) {
    console.error('Error fetching home gallery items from Contentful:', error);
  }
}
---

<div class="ArtTileContainer">
  <div class="artGrid">
    {
      artPieces.map((piece, index) => (
        <div
          class="artCard"
          data-index={index}
          data-title={piece.title}
          data-description={piece.description}
          data-store-url={piece.storeUrl || ''}
        >
          <img
            src={piece.imageUrl}
            alt={piece.title}
            class="artImage"
            width={piece.imageWidth}
            height={piece.imageHeight}
            loading="lazy"
            decoding="async"
          />
          <h3 class="artTitle">{piece.title}</h3>
        </div>
      ))
    }
  </div>
</div>

<!-- Modal -->
<div class="modal" id="artModal">
  <div class="modalContent">
    <button class="closeBtn" id="closeBtn">&times;</button>
    <img src="" alt="" class="modalImage" id="modalImage" />
    <h2 class="modalTitle" id="modalTitle"></h2>
    <div class="modalActions" id="modalActions"></div>
  </div>
</div>

<script>
  const modal = document.getElementById("artModal");
  const modalImage = document.getElementById("modalImage");
  const modalTitle = document.getElementById("modalTitle");
  const modalActions = document.getElementById("modalActions");
  const closeBtn = document.getElementById("closeBtn");
  const artCards = document.querySelectorAll(".artCard");

  artCards.forEach((card) => {
    card.addEventListener("click", () => {
      const imgElement = card.querySelector(".artImage") as HTMLImageElement;
      const title = card.getAttribute("data-title") || "";
      const storeUrl = card.getAttribute("data-store-url") || "";

      if (imgElement && modalImage) {
        (modalImage as HTMLImageElement).src = imgElement.src;
        (modalImage as HTMLImageElement).alt = title;
      }
      if (modalTitle) modalTitle.textContent = title;

      if (modalActions) {
        modalActions.innerHTML = "";
        if (storeUrl) {
          const storeButton = document.createElement("a");
          storeButton.href = storeUrl;
          storeButton.className = "storeButton";
          storeButton.textContent = "View Store Listing";
          modalActions.appendChild(storeButton);
        }
      }

      if (modal) modal.classList.add("active");
    });
  });

  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      if (modal) modal.classList.remove("active");
    });
  }

  if (modal) {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.remove("active");
      }
    });
  }
</script>
